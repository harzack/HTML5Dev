/*! 
 * a-tools 1.2
 * 
 *
 * jquery.a-tools Script (including any updated version or patch, associated code, 
 * and all associated documentation) is provided to you free of charge 
 * by Resonate KT Limited in accordance with the terms set out below 
 * and, for clarity, it is not subject to any other end user licence 
 * agreement that you may have with Resonate KT Limited or Open Text 
 * Corporation. Resonate KT Limited accepts no responsibility for jquery.a-tools 
 * Script and, to the fullest extent permitted by law, excludes all 
 * liability arising out of or related to jquery.a-tools Script and its operation 
 * or use.
 *    
 * Copyright (c) 2009 Andrey Kramarev, Ampparit Inc. (www.ampparit.com)
 * Licensed under the MIT license.
 * http://www.ampparit.fi/a-tools/license.txt
 *
 * Modifications by Resonate KT Limited (2010.02.14):
 * 	rewrote insertAtCaretPos (original had issues with IE)
 *	added setSelection()
 * 
 * Basic usage:
 
    <textarea></textarea>
    <input type="text" />

    // Get current selection
    var sel = $("textarea").getSelection()
    
    // Replace current selection
    $("input").replaceSelection("foo");

    // Count characters
    alert($("textarea").countCharacters());

    // Set max length without callback function
    $("textarea").setMaxLength(7);

    // Set max length with callback function which will be called when limit is exceeded
    $("textarea").setMaxLength(10, function() {
        alert("hello")
    });

    // Removing limit:
    $("textarea").setMaxLength(-1);
    
    // Insert text at current caret position
    $("#textarea").insertAtCaretPos("hello");
    
    // Set caret position (1 = beginning, -1 = end)
    $("#textArea").setCaretPos(10);

 */
 
var caretPositionAmp;
jQuery.fn.extend({getSelection:function(){var b=this.jquery?this[0]:this,a,c;if(document.selection){var d=document.selection.createRange();if(d.text){var h=0;if(b.value.match(/\n/g)!=null)h=b.value.match(/\n/g).length;var e=0,f=0,i=0;if(typeof b.selectionStart=="number"){a=b.selectionStart;c=b.selectionEnd;if(a==c)return this}else{a=b.createTextRange();var j,g;c=a.duplicate();j=a.text;a.moveToBookmark(d.getBookmark());g=a.text;c.setEndPoint("EndToStart",a);if(j==g&&j!=d.text)return this;a=c.text.length;
c=c.text.length+d.text.length}if(h>0)for(j=0;j<=h;j++){g=b.value.indexOf("\n",f);if(g!=-1&&g<a){f=g+1;e++;i=e}else if(g!=-1&&g>=a&&g<=c)if(g==a+1){e--;i--;f=g+1}else{f=g+1;i++}else j=h}if(d.text.indexOf("\n",0)==1)i+=2;a-=e;c-=i;return{start:a,end:c,text:d.text,length:c-a}}return false}else if(typeof b.selectionStart=="number"&&b.selectionStart!=b.selectionEnd){a=b.selectionStart;c=b.selectionEnd;b=b.value.substring(b.selectionStart,b.selectionEnd);return{start:a,end:c,text:b,length:c-a}}else return{start:undefined,
end:undefined,text:undefined,length:undefined}},replaceSelection:function(b){var a=this.jquery?this[0]:this,c,d;d=0;var h,e,f=0,i=0;if(document.selection&&typeof a.selectionStart!="number"){var j=document.selection.createRange();if(typeof a.selectionStart!="number"){var g;e=a.createTextRange();h=e.duplicate();c=e.text;e.moveToBookmark(j.getBookmark());g=e.text;h.setEndPoint("EndToStart",e);if(c==g&&c!=j.text)return this}if(j.text){part=j.text;if(a.value.match(/\n/g)!=null)f=a.value.match(/\n/g).length;
c=h.text.length;if(f>0)for(g=0;g<=f;g++){var k=a.value.indexOf("\n",d);if(k!=-1&&k<c){d=k+1;i++}else g=f}j.text=b;caretPositionAmp=h.text.length+b.length;e.move("character",caretPositionAmp);document.selection.empty();a.blur()}return this}else if(typeof a.selectionStart=="number"&&a.selectionStart!=a.selectionEnd){c=a.selectionStart;d=a.selectionEnd;a.value=a.value.substr(0,c)+b+a.value.substr(d);d=c+b.length;a.setSelectionRange(d,d);return this}return this},insertAtCaretPos:function(b){return this.each(function(){var a=
$(this);if(document.selection){a.focus();sel=document.selection.createRange();sel.text=b;a.focus()}else if(this.selectionStart||this.selectionStart=="0"){var c=this.selectionStart,d=this.selectionEnd,h=this.scrollTop;a.val(this.value.substring(0,c)+b+a.val().substring(d,a.val().length));a.focus();this.selectionStart=c+b.length;this.selectionEnd=c+b.length;this.scrollTop=h}else{this.value+=b;a.focus()}})},setCaretPos:function(b){var a=this.jquery?this[0]:this,c,d,h=0,e;a.focus();if(parseInt(b)==0)return this;
if(parseInt(b)>0){b=parseInt(b)-1;if(document.selection&&typeof a.selectionStart=="number"&&a.selectionStart==a.selectionEnd){if(a.value.match(/\n/g)!=null)d=a.value.match(/\n/g).length;if(d>0)for(var f=0;f<=d;f++){e=a.value.indexOf("\n",c);if(e!=-1&&e<=b){c=e+1;b=parseInt(b)+1}}}}else if(parseInt(b)<0){b=parseInt(b)+1;if(document.selection&&typeof a.selectionStart!="number"){b=a.value.length+parseInt(b);if(a.value.match(/\n/g)!=null)d=a.value.match(/\n/g).length;if(d>0){for(f=0;f<=d;f++){e=a.value.indexOf("\n",
c);if(e!=-1&&e<=b){c=e+1;b=parseInt(b)-1;h+=1}}b=b+h-d}}else if(document.selection&&typeof a.selectionStart=="number"){b=a.value.length+parseInt(b);if(a.value.match(/\n/g)!=null)d=a.value.match(/\n/g).length;if(d>0){b=parseInt(b)-d;for(f=0;f<=d;f++){e=a.value.indexOf("\n",c);if(e!=-1&&e<=b){c=e+1;b=parseInt(b)+1;h+=1}}}}else b=a.value.length+parseInt(b)}else return this;if(document.selection&&typeof a.selectionStart!="number"){c=document.selection.createRange();if(c.text!=0)return this;d=a.createTextRange();
d.moveToBookmark(c.getBookmark());d.move("character",b);d.select();c=document.selection.createRange();c.text="";caretPositionAmp=b;a.focus();return this}else if(typeof a.selectionStart=="number"&&a.selectionStart==a.selectionEnd){a.setSelectionRange(b,b);return this}return this},countCharacters:function(){var b=this.jquery?this[0]:this;if(b.value.match(/\r/g)!=null)return b.value.length-b.value.match(/\r/g).length;return b.value.length},setMaxLength:function(b,a){this.each(function(){var c=this.jquery?
this[0]:this,d=c.type,h,e;if(parseInt(b)<0)b=1E8;if(d=="text")c.maxLength=b;if(d=="textarea"||d=="text"){c.onkeypress=function(f){var i=c.value.match(/\r/g);e=b;if(i!=null)e=parseInt(e)+i.length;f=f||event;i=f.keyCode;h=document.selection?document.selection.createRange().text.length>0:c.selectionStart!=c.selectionEnd;if(c.value.length>=e&&(i>47||i==32||i==0||i==13)&&!f.ctrlKey&&!f.altKey&&!h){c.value=c.value.substring(0,e);typeof a=="function"&&a();return false}};c.onkeyup=function(){var f=c.value.match(/\r/g),
i=0,j=0;e=b;if(f!=null){for(var g=0;g<=f.length;g++)if(c.value.indexOf("\n",j)<=parseInt(b)){i++;j=c.value.indexOf("\n",j)+1}e=parseInt(b)+i}if(c.value.length>e){c.value=c.value.substring(0,e);typeof a=="function"&&a();return this}}}else return this});return this},setSelection:function(b,a){a=a||b;if(this[0]&&this[0].setSelectionRange){this[0].focus();this[0].setSelectionRange(b,a)}else if(this[0]&&this[0].createTextRange){var c=this[0].createTextRange();c.collapse(true);c.moveEnd("character",a);
c.moveStart("character",b);c.select()}return this}});